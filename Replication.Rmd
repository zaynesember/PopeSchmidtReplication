---
title: "Replication Project"
subtitle: "POLI 271: Advanced Statistical Applications"
author: "Zayne Sember"
date: "4/27/2021"
output: pdf_document
header-includes:
   - \usepackage[default]{sourcesanspro}
   - \usepackage[T1]{fontenc}
mainfont: SourceSansPro
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(haven)
library(ggplot2)
library(tidyverse)
library(sandwich)
library(grid)
library(gridExtra)
library(corrplot)
library(Amelia)
library(ggeffects)
library(modelsummary)
library(AER)
library(sampleSelection)
library(stargazer)
library(kableExtra)
```

```{r}
dataset <- read_dta("Original Dataset/founding fathers dataset-corrections-attendance-replication.dta")

dataset_select <- dataset %>% select(index1, sons, dtrs, age, revoffco, 
                       nslave, dist1, vsecr, vbank, ddebt, pols, lawyer) %>% na.omit()
```

# 1. A histogram of the dependent variable
```{r, echo=FALSE}
ggplot(aes(x=index1),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="darkblue") +
  xlab("Preferred Index") +
  ylab("") +
  ggtitle("Preferred Vote Index Distribution") +
  scale_x_continuous(breaks = 1:8) +
  scale_y_continuous(breaks = 1:10) +
  theme_bw()
```

```{r, echo=FALSE}
vote1 <- ggplot(aes(x=vote2),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="coral4") +
  xlab("National Veto Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote2 <- ggplot(aes(x=anti5),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="chocolate2") +
  xlab("Debtor Legislators Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote3 <- ggplot(aes(x=anti6),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="cadetblue3") +
  xlab("Cong. Quorum Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote4 <- ggplot(aes(x=anti7),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="deeppink3") +
  xlab("National Exports Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote5 <- ggplot(aes(x=vote8),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="darkorchid3") +
  xlab("Militia Control Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote6 <- ggplot(aes(x=vote9),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="indianred3") +
  xlab("State Credit Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote7 <- ggplot(aes(x=anti14),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="seagreen3") +
  xlab("Navigation Acts Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

vote8 <- ggplot(aes(x=vote15),data=dataset) +
  geom_histogram(binwidth = 0.5, col="darkgray", fill="thistle4") +
  xlab("Military Responsibility Vote") +
  ylab("") +
  scale_x_continuous(breaks = c(0,1)) +
  theme_bw()

grid.arrange(vote1, vote2, vote3, vote4, vote5, vote6, vote7, vote8,
             ncol=3, nrow=3, top="Individual Vote Distributions")
```

# 2. A correlation matrix for the DV and IVs that the original authors included in the model you are replicating

## Correlation Matrix of Model Variables
```{r, out.width=1000}
n <- dataset %>% select(index1, vote2, anti5, anti6, anti7, vote8, vote9, anti14, vote15, sons, dtrs, ageco, agecosq, revoffco,
                     nslave, dist2, vsecr, vbank, ddebt, pols, lawyer)
m <- cor(n)

corrplot(m, method="color", addCoef.col = "black",
         tl.col="gray16", tl.srt=45, number.cex=0.4)
```
Note: `index`, `anti`, and `vote` variables are dependent in the paper, all others are independent.

# 3. A visual or tabular depiction of the missingness in the data from part (2); see p. 251-255 of the text.
```{r, warning=FALSE}
DVs <- dataset %>% select(index1, vote2, anti5, anti6, anti7, vote8,
                               vote9, anti14, vote15)

IVs <- dataset %>% select(sons, dtrs, ageco, 
                               agecosq, revoffco, nslave, dist2, vsecr, vbank,
                               ddebt, pols, lawyer)
missmap(DVs, main="Dependent Variable Missingness")
missmap(IVs, main="Independent Variable Missingness")
```
While there is no missingness visible in the replication dataset, the authors do state that "The second reason for McDonald’s selection of the sixteen key votes is that he claimed there is enough information from Farrand’s Records, delegate diaries, and other sources—to estimate how each individual delegate would have voted on this issue" (Pope and Schmidt 2021, 6). This implies that data is missing but was imputed by the authors. A replication extension could be to determine which data points are imputed and do sensitivity testing without those data.


```{r}
# Code taken from:
# https://stats.stackexchange.com/questions/89999/
# how-to-replicate-statas-robust-binomial-glm-for-proportion-data-in-r
# Creates robust standard errors for glm models
robustify <- function(model){
  cov.m1 <- vcovHC(model, type = "HC0")
  
  std.err <- sqrt(diag(cov.m1))
  
  q.val <- qnorm(0.975)
  
  retVal <- cbind(
    Estimate = coef(model)
    , "Robust SE" = std.err
    , z = (coef(model)/std.err)
    , "Pr(>|z|) "= 2 * pnorm(abs(coef(model_poisson)/std.err), 
                             lower.tail = FALSE)
    , LL = coef(model_poisson) - q.val  * std.err
    , UL = coef(model_poisson) + q.val  * std.err
  )
  return(retVal)
}

# Because R and STATA don't get along, this function takes a 
# sampleSelection::probit model with robust SEs and formats the output to be
# presented in a neat table since stargazer and modelsummary don't support
# the model output by sampleSelection
fmt_col <- function(model, DV){
  ests <- rep(NA, nrow(model))
  errs <- rep(NA, nrow(model))
  
  for(i in 1:nrow(model)){
    sig <- ""
    if(model$p[i] < 0.01){sig <- '***'}
    else if(model$p[i] < 0.05){sig <- '**'}
    else if(model$p[i] < 0.1){sig <- '*'}
    
    ests[i] <- paste(model$estimate[i],sig, sep="")
    errs[i] <- paste("(",model$stderr[i],")",sep="")
  }
  return(c(rbind(ests,errs),toString(length(DV))))
}

```

```{r, warning=FALSE}

model_poisson <- glm(index1 ~ sons + dtrs + ageco + agecosq + revoffco
                     + nslave + dist2 + vsecr + vbank + ddebt + pols + lawyer,
                     data=dataset, family = poisson(link = "log"))

# Generate the model with robust SEs and get it into a workable type
model_poisson <- as.data.frame(matrix(round(robustify(glm(index1 ~ sons + dtrs + ageco + agecosq + revoffco + nslave + dist2 + vsecr + vbank + ddebt + pols + lawyer, data=dataset,
                     family = poisson(link = "log")))[,1:4],4), ncol=4))
colnames(model_poisson) <- c("estimate", "stderr", "t", "p") # TODO: WHY IS THIS BUGGY?

# Format the model output so it's ready for the table
pn <- fmt_col(model_poisson, dataset$index1)

# model_probit1 <- glm(vote2 ~ sons + dtrs + ageco + agecosq +
#                     revoffco + nslave + dist2 + vsecr + vbank +
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit1 <- as.data.frame(matrix(round(coeftest(probit(vote2 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit1) <- c("estimate", "stderr", "t", "p")

p1 <- fmt_col(model_probit1, dataset$vote2)

# model_probit2 <- glm(anti5 ~ sons + dtrs + ageco + agecosq +
#                     revoffco + nslave + dist2 + vsecr + vbank +
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit2 <- as.data.frame(matrix(round(coeftest(probit(anti5 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit2) <- c("estimate", "stderr", "t", "p")

p2 <- fmt_col(model_probit2, dataset$anti5)

# model_probit3 <- glm(anti6 ~ sons + dtrs + ageco + agecosq + 
#                     revoffco + nslave + dist2 + vsecr + vbank + 
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit3 <- as.data.frame(matrix(round(coeftest(probit(anti6 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit3) <- c("estimate", "stderr", "t", "p")

p3 <- fmt_col(model_probit3, dataset$anti6)

# model_probit4 <- glm(anti7 ~ sons + dtrs + ageco + agecosq +
#                     revoffco + nslave + dist2 + vsecr + vbank +
#                     pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit4 <- as.data.frame(matrix(round(coeftest(probit(anti7 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank +
                    pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit4) <- c("estimate", "stderr", "t", "p")

p4 <- fmt_col(model_probit4, dataset$anti7)
p4 <- append(p4, c("-","-"),20) # TODO: WHY DOESN'T THIS MATCH?

# model_probit5 <- glm(vote8 ~ sons + dtrs + ageco + agecosq + 
#                     revoffco + nslave + dist2 + vsecr + vbank + 
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit5 <- as.data.frame(matrix(round(coeftest(probit(vote8 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit5) <- c("estimate", "stderr", "t", "p")

p5 <- fmt_col(model_probit5, dataset$vote8)

# model_probit6 <- glm(vote9 ~ sons + dtrs + ageco + agecosq + 
#                     revoffco + nslave + dist2 + vsecr + 
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit6 <- as.data.frame(matrix(round(coeftest(probit(vote9 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit6) <- c("estimate", "stderr", "t", "p")

p6 <- fmt_col(model_probit6, dataset$vote9)
p6 <- append(p6, c("-","-"),18) # TODO: WHY DOESN'T THIS MATCH?

# model_probit7 <- glm(anti14 ~ sons + dtrs + ageco + agecosq + 
#                     revoffco + nslave + dist2 + vsecr + vbank + 
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit7 <- as.data.frame(matrix(round(coeftest(probit(anti14 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit7) <- c("estimate", "stderr", "t", "p")

p7 <- fmt_col(model_probit7, dataset$anti14)

# model_probit8 <- glm(vote15 ~ sons + dtrs + ageco + agecosq + 
#                     revoffco + nslave + dist2 + vsecr + vbank + 
#                     ddebt + pols + lawyer,
#                     data=dataset, family=binomial(link="probit"))

model_probit8 <- as.data.frame(matrix(round(coeftest(probit(vote15 ~ sons + dtrs + ageco + agecosq + 
                    revoffco + nslave + dist2 + vsecr + vbank + 
                    ddebt + pols + lawyer,
                    data=dataset), vcovCL),4), ncol=4))
colnames(model_probit8) <- c("estimate", "stderr", "t", "p")

p8 <- fmt_col(model_probit8, dataset$vote15)

# Column names for Table 2
cnames=c("Preferred Index","National Veto","Debtor Legislators","Cong. Quorum.",
           "National Exports","Militia Control","State Credit",
           "Navigation Acts","Military Responsibility")

# Row names for Table 2 (with ugly hack to get spacing right)
rnames=c("Constant","","Number of sons"," ","Number of daughters","  ","Age",
         "   ","Age squared","    ",
         "Revolutionary war officer","     ","Logged number of slaves","      ", 
         "Distance to navigable coastline","       ",
         "Public securities (1000s, 1787 dollars)","        ",
         "Private securities (1000s, 1787 dollars)","         ",
         "Debtor (dummy)","          ", "Politician","           ", "Lawyer",
         "             ", "Observations") 

# Assemble the dataframe with the model outputs and assign names
table2 <- as.data.frame(cbind(pn,p1, p2, p3, p4, p5, p6, p7, p8))
colnames(table2) <- cnames
rownames(table2) <- rnames
```

```{r}
# Generate Table 2
kable(table2, booktabs=T) %>% 
  kable_styling(latex_options="scale_down") %>% 
  landscape() 
```



